<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‹˜å®šç§‘ç›® åˆ†é¡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° RPG</title>
  <style>
    :root{
      --border:#ddd;
      --border2:#ccc;
      --text-muted:#666;
      --ok:#0a7;
      --ng:#c33;
      --warn:#b60;
      --radius:14px;

      /* è‰²åˆ†ã‘ */
      --asset-bg: #eef6ff;   --asset-bd:#b7d7ff;
      --liab-bg:  #fff2f2;   --liab-bd:#ffc2c2;
      --equity-bg:#f3efff;   --equity-bd:#d2c6ff;
      --exp-bg:   #fff7e6;   --exp-bd:#ffd08a;
      --rev-bg:   #effff4;   --rev-bd:#b7f0c6;
      --other-bg: #f5f5f5;   --other-bd:#d9d9d9;
    }

    body { font-family: sans-serif; max-width: 920px; margin: 24px auto; padding: 0 12px; background-color: #f9f9f9; }
    .card { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .muted { color: var(--text-muted); font-size: 14px; }
    .big { font-size: 30px; font-weight: 800; margin: 10px 0 14px; line-height:1.2; }
    .ok { color: var(--ok); font-weight: 900; }
    .ng { color: var(--ng); font-weight: 900; }
    .warn { color: var(--warn); font-weight: 900; }
    .small { font-size: 12px; color: var(--text-muted); }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; margin: 12px 0 8px; }
    label { user-select:none; cursor: pointer; }
    select { padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border2); background: #fff; }
    input[type="checkbox"] { transform: scale(1.15); margin-right: 4px; }

    button { border-radius: 14px; border: 1px solid var(--border2); background: #fff; cursor: pointer; transition: all 0.2s; }
    button:hover { opacity: .92; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button:active { transform: translateY(1px); box-shadow: none; }
    .actionBtn { padding: 10px 16px; font-weight: 700; white-space: nowrap; color: #444; }

    .grid { display: grid; gap: 10px; margin-top: 16px; }
    @media (max-width: 520px){ .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 521px) and (max-width: 860px){ .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (min-width: 861px){ .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    
    .typeBtn{
      padding: 16px 10px; min-height: 60px;
      font-size: 16px; font-weight: 800; line-height: 1.2; text-align: center;
    }

    /* ãƒœã‚¿ãƒ³è‰²ï¼ˆå¤§åˆ†é¡ï¼‰ */
    .btn-asset { background: var(--asset-bg); border-color: var(--asset-bd); color: #004488; }
    .btn-liab  { background: var(--liab-bg);  border-color: var(--liab-bd);  color: #880000; }
    .btn-equity{ background: var(--equity-bg);border-color: var(--equity-bd);color: #330088; }
    .btn-exp   { background: var(--exp-bg);   border-color: var(--exp-bd);   color: #884400; }
    .btn-rev   { background: var(--rev-bg);   border-color: var(--rev-bd);   color: #006622; }
    .btn-other { background: var(--other-bg); border-color: var(--other-bd); color: #444; }

    .summary { margin-top: 20px; padding-top:10px; border-top: 1px solid #eee; display:flex; flex-wrap:wrap; gap:10px 16px; align-items:center; }
    .legend { display:flex; flex-wrap:wrap; gap:8px; margin-top: 12px; }
    .tag { font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); user-select: none; }
    .tag.asset { background: var(--asset-bg); border-color: var(--asset-bd); }
    .tag.liab  { background: var(--liab-bg);  border-color: var(--liab-bd); }
    .tag.equity{ background: var(--equity-bg);border-color: var(--equity-bd);}
    .tag.exp   { background: var(--exp-bg);   border-color: var(--exp-bd); }
    .tag.rev   { background: var(--rev-bg);   border-color: var(--rev-bd); }
    .tag.other { background: var(--other-bg); border-color: var(--other-bd); }

    /* æ­£è§£/ä¸æ­£è§£è¡¨ç¤º */
    #result { font-size: 20px; font-weight: 700; margin-top: 16px; min-height: 1.5em; }
    #result .ok, #result .ng { font-size: 24px; margin-right: 8px; }

    /* 20å•çµ‚äº†ç”»é¢ */
    #stageClear { display:none; text-align:center; padding: 24px 0; }
    #stageClear .title { font-size: 32px; font-weight: 800; margin: 16px 0; color: #333; }
    #stageClear .sub { font-size: 16px; margin: 8px 0 20px; color: #555; }
    #stageClear .btn { font-size: 18px; padding: 14px 32px; border-radius: 16px; font-weight: 900; background: #333; color: #fff; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    #stageClear .btn:hover { background: #555; transform: translateY(-2px); }
    #stageClear .stats { margin-top: 16px; font-size: 14px; color: var(--text-muted); }

    /* â˜… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆRPGè¦ç´ ï¼‰ */
    .status-bar { 
      display: flex; align-items: center; gap: 16px; 
      margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px dashed var(--border);
    }
    .char-icon { font-size: 48px; line-height: 1; animation: bounce 2s infinite; cursor: default; }
    .char-info { flex: 1; }
    .char-name { font-weight: 800; font-size: 18px; color: #333; margin-bottom: 4px; }
    .char-next { font-size: 12px; color: var(--text-muted); font-weight: 500; }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  </style>
</head>

<body>
  <div style="margin-bottom:10px;">
    <h2 style="margin:0;">å‹˜å®šç§‘ç›® åˆ†é¡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
    <span class="small">Enterã‚­ãƒ¼ã§ã€Œæ¬¡ã¸ã€ / æ­£è§£ã™ã‚‹ã¨è‡ªå‹•ã§é€²ã¿ã¾ã™</span>
  </div>

  <div class="card">
    
    <div class="status-bar">
      <div class="char-icon" id="charIcon">ğŸ¥š</div>
      <div class="char-info">
        <div class="char-name" id="charName">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="char-next" id="charNext"></div>
      </div>
      <div style="text-align:right;">
        <div class="small">ç´¯è¨ˆæ­£è§£</div>
        <div style="font-weight:800; font-size:18px;"><span id="totalAccumulated">0</span>å•</div>
      </div>
    </div>

    <div id="quizArea">
      <div class="muted">æ¬¡ã®å‹˜å®šç§‘ç›®ã®ã€Œã‚¿ã‚¤ãƒ—ã€ã¯ï¼Ÿ</div>
      <div id="account" class="big">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
    </div>

    <div id="stageClear">
      <div class="title">ğŸ‰ 20å•çµ‚äº†ï¼</div>
      <div id="lapMsg" class="sub"></div>
      <button class="btn" onclick="startNextLap()">æ¬¡ã®20å•ã¸ â–¶</button>
      <div class="stats">
        ä»Šå›ã®æˆç¸¾ï¼šæ­£è§£ <span id="scCorrect">0</span> / <span id="scCount">0</span> å•
      </div>
    </div>

    <div class="toolbar">
      <label class="small">
        <input id="toggleOther" type="checkbox" checked>
        ãã®ä»–ã‚‚å«ã‚ã‚‹
      </label>

      <label class="small">
        <select id="typeFilter">
          <option value="__ALL__">ã™ã¹ã¦</option>
        </select>
      </label>

      <div style="flex:1;"></div>
      <button class="actionBtn" onclick="next()" title="Enterã‚­ãƒ¼ã§ã‚‚é€²ã‚ã¾ã™">ã‚¹ã‚­ãƒƒãƒ— / æ¬¡ã¸</button>
      <button class="actionBtn" onclick="resetScore()" style="color:#c33;">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="legend">
      <span class="tag asset">è³‡ç”£</span>
      <span class="tag liab">è² å‚µ</span>
      <span class="tag equity">ç´”è³‡ç”£</span>
      <span class="tag exp">è²»ç”¨</span>
      <span class="tag rev">åç›Š</span>
      <span class="tag other">ãã®ä»–</span>
    </div>

    <div id="buttons" class="grid"></div>

    <p id="result" class="muted"></p>

    <div class="summary muted">
      <span>ä»Šå›ï¼š<span id="correct">0</span> / <span id="count">0</span> å•æ­£è§£</span>
      <span class="small" style="margin-left:auto;">
        (æ®‹ã‚Š: <span id="remain">0</span> | å‘¨å›: <span id="lap">0</span>)
      </span>
    </div>
  </div>

<script>
  // â˜… ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«åŸ‹ã‚è¾¼ã¿ã¾ã—ãŸï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸è¦ã§å‹•ãã¾ã™ï¼‰
  const RAW_CSV_DATA = `
account,type
ç¾é‡‘,æµå‹•è³‡ç”£
å°å£ç¾é‡‘,æµå‹•è³‡ç”£
å½“åº§é é‡‘,æµå‹•è³‡ç”£
å—å–æ‰‹å½¢,æµå‹•è³‡ç”£
å£²æ›é‡‘,æµå‹•è³‡ç”£
é›»å­è¨˜éŒ²å‚µæ¨©,æµå‹•è³‡ç”£
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²æ›é‡‘,æµå‹•è³‡ç”£
ç¹°è¶Šå•†å“,æµå‹•è³‡ç”£
è²¸å€’å¼•å½“é‡‘,æµå‹•è³‡ç”£
æ¶ˆè€—å“,æµå‹•è³‡ç”£
ä»®æ‰•é‡‘,æµå‹•è³‡ç”£
ç«‹æ›¿é‡‘,æµå‹•è³‡ç”£
å‰æ‰•é‡‘,æµå‹•è³‡ç”£
ç¾é‡‘éä¸è¶³,æµå‹•è³‡ç”£
è²¯è”µå“,æµå‹•è³‡ç”£
å»ºç‰©,å›ºå®šè³‡ç”£
å»ºç‰©æ¸›ä¾¡å„Ÿå´ç´¯è¨ˆé¡,å›ºå®šè³‡ç”£
å‚™å“,å›ºå®šè³‡ç”£
å‚™å“æ¸›ä¾¡å„Ÿå´ç´¯è¨ˆé¡,å›ºå®šè³‡ç”£
è»Šä¸¡é‹æ¬å…·,å›ºå®šè³‡ç”£
è»Šä¸¡é‹æ¬å…·æ¸›ä¾¡å„Ÿå´ç´¯è¨ˆé¡,å›ºå®šè³‡ç”£
åœŸåœ°,å›ºå®šè³‡ç”£
ã®ã‚Œã‚“,å›ºå®šè³‡ç”£
ç‰¹è¨±æ¨©,å›ºå®šè³‡ç”£
å•†æ¨™æ¨©,å›ºå®šè³‡ç”£
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢,å›ºå®šè³‡ç”£
æŠ•è³‡æœ‰ä¾¡è¨¼åˆ¸,å›ºå®šè³‡ç”£
æ•·é‡‘,å›ºå®šè³‡ç”£
æ”¯æ‰•æ‰‹å½¢,æµå‹•è² å‚µ
è²·æ›é‡‘,æµå‹•è² å‚µ
é›»å­è¨˜éŒ²å‚µå‹™,æµå‹•è² å‚µ
å‰å—é‡‘,æµå‹•è² å‚µ
æœªæ‰•é‡‘,æµå‹•è² å‚µ
ä»®å—é‡‘,æµå‹•è² å‚µ
é ã‚Šé‡‘,æµå‹•è² å‚µ
æœªæ‰•æ³•äººç¨ç­‰,æµå‹•è² å‚µ
æœªæ‰•é…å½“é‡‘,æµå‹•è² å‚µ
å½“åº§å€Ÿè¶Š,æµå‹•è² å‚µ
çŸ­æœŸå€Ÿå…¥é‡‘,æµå‹•è² å‚µ
æœªæ‰•è²»ç”¨,æµå‹•è² å‚µ
å‰å—åç›Š,æµå‹•è² å‚µ
ç¤¾å‚µ,å›ºå®šè² å‚µ
é•·æœŸå€Ÿå…¥é‡‘,å›ºå®šè² å‚µ
é€€è·çµ¦ä»˜å¼•å½“é‡‘,å›ºå®šè² å‚µ
è³‡æœ¬é‡‘,ç´”è³‡ç”£
è³‡æœ¬æº–å‚™é‡‘,ç´”è³‡ç”£
ãã®ä»–è³‡æœ¬å‰°ä½™é‡‘,ç´”è³‡ç”£
åˆ©ç›Šæº–å‚™é‡‘,ç´”è³‡ç”£
ç¹°è¶Šåˆ©ç›Šå‰°ä½™é‡‘,ç´”è³‡ç”£
è‡ªå·±æ ªå¼,ç´”è³‡ç”£
ä»•å…¥,å–¶æ¥­è²»ç”¨
çµ¦æ–™,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
çµ¦æ–™æ‰‹å½“,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ³•å®šç¦åˆ©è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
åºƒå‘Šå®£ä¼è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
ç™ºé€è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ—…è²»äº¤é€šè²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
é€šä¿¡è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ°´é“å…‰ç†±è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ¶ˆè€—å“è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
ç§Ÿç¨å…¬èª²,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
ä¿é™ºæ–™,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
ä¿®ç¹•è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
è³ƒå€Ÿæ–™,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ”¯æ‰•å®¶è³ƒ,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ”¯æ‰•åœ°ä»£,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
ä¿ç®¡è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
è²¸å€’å¼•å½“é‡‘ç¹°å…¥,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
è²¸å€’æå¤±,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ¸›ä¾¡å„Ÿå´è²»,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
ã®ã‚Œã‚“å„Ÿå´,è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»
æ”¯æ‰•åˆ©æ¯,å–¶æ¥­å¤–è²»ç”¨
æ‰‹å½¢å£²å´æ,å–¶æ¥­å¤–è²»ç”¨
æœ‰ä¾¡è¨¼åˆ¸å£²å´æ,å–¶æ¥­å¤–è²»ç”¨
æœ‰ä¾¡è¨¼åˆ¸è©•ä¾¡æ,å–¶æ¥­å¤–è²»ç”¨
ç‚ºæ›¿å·®æ,å–¶æ¥­å¤–è²»ç”¨
é›‘æ,å–¶æ¥­å¤–è²»ç”¨
å›ºå®šè³‡ç”£å£²å´æ,ç‰¹åˆ¥æå¤±
å›ºå®šè³‡ç”£é™¤å´æ,ç‰¹åˆ¥æå¤±
ç«ç½æå¤±,ç‰¹åˆ¥æå¤±
å£²ä¸Š,å–¶æ¥­åç›Š
å—å–åˆ©æ¯,å–¶æ¥­å¤–åç›Š
å—å–é…å½“é‡‘,å–¶æ¥­å¤–åç›Š
æœ‰ä¾¡è¨¼åˆ¸åˆ©æ¯,å–¶æ¥­å¤–åç›Š
æœ‰ä¾¡è¨¼åˆ¸å£²å´ç›Š,å–¶æ¥­å¤–åç›Š
æœ‰ä¾¡è¨¼åˆ¸è©•ä¾¡ç›Š,å–¶æ¥­å¤–åç›Š
ç‚ºæ›¿å·®ç›Š,å–¶æ¥­å¤–åç›Š
é›‘ç›Š,å–¶æ¥­å¤–åç›Š
å›ºå®šè³‡ç”£å£²å´ç›Š,ç‰¹åˆ¥åˆ©ç›Š
å„Ÿå´å‚µæ¨©å–ç«‹ç›Š,ç‰¹åˆ¥åˆ©ç›Š
æç›Š,ãã®ä»–
`;

  const MAX_QUESTIONS = 20;

  // â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¬ãƒ™ãƒ«è¨­å®š (RPGè¦ç´ )
  const CHARACTERS = [
    { score: 0,    icon: 'ğŸ¥š', name: 'Lv.1 ç°¿è¨˜ã®ãŸã¾ã”' },
    { score: 20,   icon: 'ğŸ£', name: 'Lv.2 æ–°äººãƒ”ãƒ¨ãƒ”ãƒ¨' },
    { score: 50,   icon: 'ğŸ¥', name: 'Lv.3 ã‹ã‘ã ã—çµŒç†' },
    { score: 100,  icon: 'ğŸ¢', name: 'Lv.4 ã‚³ãƒ„ã‚³ãƒ„äº€ã•ã‚“' },
    { score: 180,  icon: 'ğŸ‡', name: 'Lv.5 ç–¾é¢¨ã®ä»•è¨³äºº' },
    { score: 280,  icon: 'ğŸ¦‰', name: 'Lv.6 è³¢è€…ã®çŸ¥æµ' },
    { score: 400,  icon: 'ğŸ†', name: 'Lv.7 æ±ºç®—ã®ç‹©äºº' },
    { score: 550,  icon: 'ğŸ¦', name: 'Lv.8 è²¡å‹™ã®ç‹' },
    { score: 750,  icon: 'ğŸ²', name: 'Lv.9 ä¼èª¬ã®ä¼šè¨ˆé¾' },
    { score: 1000, icon: 'ğŸ§š', name: 'Lv.10 ç°¿è¨˜ãƒã‚¹ã‚¿ãƒ¼' },
  ];

  // ç´¯è¨ˆæ­£è§£æ•°
  let totalCorrectAccumulated = 0;

  const TYPE_ORDER = [
    'æµå‹•è³‡ç”£','å›ºå®šè³‡ç”£','æµå‹•è² å‚µ','å›ºå®šè² å‚µ','ç´”è³‡ç”£',
    'å–¶æ¥­è²»ç”¨','è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»','å–¶æ¥­å¤–è²»ç”¨','ç‰¹åˆ¥æå¤±',
    'å–¶æ¥­åç›Š','å–¶æ¥­å¤–åç›Š','ç‰¹åˆ¥åˆ©ç›Š','ãã®ä»–'
  ];

  const TYPE_TO_GROUP = new Map([
    ['æµå‹•è³‡ç”£','asset'], ['å›ºå®šè³‡ç”£','asset'],
    ['æµå‹•è² å‚µ','liab'],  ['å›ºå®šè² å‚µ','liab'],
    ['ç´”è³‡ç”£','equity'],
    ['å–¶æ¥­è²»ç”¨','exp'], ['è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»','exp'], ['å–¶æ¥­å¤–è²»ç”¨','exp'], ['ç‰¹åˆ¥æå¤±','exp'],
    ['å–¶æ¥­åç›Š','rev'], ['å–¶æ¥­å¤–åç›Š','rev'], ['ç‰¹åˆ¥åˆ©ç›Š','rev'],
    ['ãã®ä»–','other'],
  ]);
  const GROUP_TO_BTNCLASS = {
    asset: 'btn-asset', liab: 'btn-liab', equity:'btn-equity',
    exp: 'btn-exp', rev: 'btn-rev', other:'btn-other',
  };

  const BS_TYPES = new Set(['æµå‹•è³‡ç”£','å›ºå®šè³‡ç”£','æµå‹•è² å‚µ','å›ºå®šè² å‚µ','ç´”è³‡ç”£']);
  const PL_TYPES = new Set(['å–¶æ¥­è²»ç”¨','è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»','å–¶æ¥­å¤–è²»ç”¨','ç‰¹åˆ¥æå¤±','å–¶æ¥­åç›Š','å–¶æ¥­å¤–åç›Š','ç‰¹åˆ¥åˆ©ç›Š']);

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
  let allItems = [];
  let items = [];
  let types = [];
  let current = null;
  let answered = false;
  let count = 0;
  let correct = 0;
  let deck = [];
  let deckIndex = 0;
  let lap = 0;

  // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ ---
  function saveProgress() {
    localStorage.setItem('bokiApp_totalCorrect', totalCorrectAccumulated);
  }
  function loadProgress() {
    const saved = localStorage.getItem('bokiApp_totalCorrect');
    if (saved) totalCorrectAccumulated = parseInt(saved, 10);
    document.getElementById('totalAccumulated').textContent = totalCorrectAccumulated;
  }
  // -----------------------------

  // --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–° ---
  function updateCharacterUI() {
    let currentChara = CHARACTERS[0];
    let nextChara = null;

    for (let i = 0; i < CHARACTERS.length; i++) {
      if (totalCorrectAccumulated >= CHARACTERS[i].score) {
        currentChara = CHARACTERS[i];
        if (i + 1 < CHARACTERS.length) nextChara = CHARACTERS[i + 1];
        else nextChara = null;
      }
    }

    document.getElementById('charIcon').textContent = currentChara.icon;
    document.getElementById('charName').textContent = currentChara.name;
    document.getElementById('totalAccumulated').textContent = totalCorrectAccumulated;

    const nextEl = document.getElementById('charNext');
    if (nextChara) {
      const remain = nextChara.score - totalCorrectAccumulated;
      nextEl.textContent = `ã‚ã¨æ­£è§£ ${remain} å›ã§é€²åŒ–`;
      nextEl.style.color = 'var(--text-muted)';
    } else {
      nextEl.textContent = `æœ€é«˜ãƒ©ãƒ³ã‚¯åˆ°é”ï¼`;
      nextEl.style.color = 'var(--ok)';
    }
  }
  // -----------------------------

  function normalizeType(s){ return String(s ?? '').replace(/\s+/g,' ').trim(); }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function sortTypesWithOrder(typeList){
    const orderIndex = new Map(TYPE_ORDER.map((t,i)=>[t,i]));
    return [...typeList].sort((a,b)=>{
      const ai = orderIndex.has(a) ? orderIndex.get(a) : 9999;
      const bi = orderIndex.has(b) ? orderIndex.get(b) : 9999;
      if (ai !== bi) return ai - bi;
      return a.localeCompare(b, 'ja');
    });
  }

  function updateRemain(){
    const remain = Math.max(0, deck.length - deckIndex);
    document.getElementById('remain').textContent = String(remain);
  }

  function showQuizUI(){
    document.getElementById("stageClear").style.display = "none";
    document.getElementById("quizArea").style.display = "block";
    document.getElementById("buttons").style.display = "grid";
  }

  function showClearUI(){
    document.getElementById("quizArea").style.display = "none";
    document.getElementById("buttons").style.display = "none";
    document.getElementById("stageClear").style.display = "block";

    document.getElementById("scCorrect").textContent = String(correct);
    document.getElementById("scCount").textContent = String(count);
    document.getElementById("lapMsg").textContent = `${lap}å‘¨ç›®ã‚¯ãƒªã‚¢ï¼ãŠç–²ã‚Œæ§˜ï¼`;
  }

  function prepareDeck(){
    deck = [...items];
    shuffle(deck);
    deckIndex = 0;
    lap += 1;
    document.getElementById('lap').textContent = String(lap);
    updateRemain();
  }

  function startNextLap(){
    showQuizUI();
    document.getElementById("result").textContent = "";
    prepareDeck();
    next();
  }

  function renderScore(){
    document.getElementById("count").textContent = count;
    document.getElementById("correct").textContent = correct;
  }

  function show(item){
    current = item;
    answered = false;
    document.getElementById("account").textContent = item ? item.name : "â€”";
    document.getElementById("result").textContent = "";
  }

  function answer(type){
    if (!current || answered) return;
    answered = true;
    count++;

    const ok = (type === current.type);
    if (ok) {
      correct++;
      // â˜… æ­£è§£æ™‚ã®å‡¦ç†ï¼šçµŒé¨“å€¤åŠ ç®—
      totalCorrectAccumulated++;
      saveProgress();
      updateCharacterUI();
    }

    document.getElementById("result").innerHTML =
      ok
        ? `<span class="ok">â­• æ­£è§£ï¼</span><span class="muted small">${current.name} ã¯ ${current.type} ã§ã™</span>`
        : `<span class="ng">âŒ ä¸æ­£è§£...</span><span class="muted small">æ­£è§£ã¯ã€Œ${current.type}ã€ã§ã—ãŸ</span>`;

    renderScore();

    // â˜… UXå‘ä¸Šï¼šæ­£è§£ãªã‚‰è‡ªå‹•ã§æ¬¡ã¸
    if (ok) {
      setTimeout(() => {
        // ã¾ã å•é¡ŒãŒæ®‹ã£ã¦ã„ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ç”»é¢ã˜ã‚ƒãªã„å ´åˆã®ã¿
        if (deckIndex < deck.length) {
          next();
        } else {
          // æœ€å¾Œã®å•é¡Œã ã£ãŸå ´åˆã¯ã™ãã«æ¬¡ã¸ï¼ˆã‚¯ãƒªã‚¢ç”»é¢è¡¨ç¤ºã®ãŸã‚ï¼‰
          next();
        }
      }, 600); // 0.6ç§’å¾Œã«é·ç§»
    }
  }

  function next(){
    if (!deck.length) return;

    // å…¨å•çµ‚äº†ãƒã‚§ãƒƒã‚¯
    if (deckIndex >= deck.length) {
      showClearUI();
      return;
    }

    show(deck[deckIndex]);
    deckIndex++;
    updateRemain();
  }

  function resetScore(){
    if(!confirm("ç¾åœ¨ã®å‘¨å›ã®ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆç´¯è¨ˆãƒ¬ãƒ™ãƒ«ã¯ç¶­æŒã•ã‚Œã¾ã™ï¼‰")) return;
    count = 0;
    correct = 0;
    renderScore();
    lap = 0;
    applyFiltersAndReady();
  }

  function buildButtons(typeList){
    const wrap = document.getElementById('buttons');
    wrap.innerHTML = '';
    typeList.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'typeBtn';
      const grp = TYPE_TO_GROUP.get(t) || 'other';
      btn.classList.add(GROUP_TO_BTNCLASS[grp] || 'btn-other');
      btn.textContent = t;
      btn.onclick = () => answer(t);
      wrap.appendChild(btn);
    });
  }

  function buildTypeFilter(typeList){
    const sel = document.getElementById('typeFilter');
    const cur = sel.value;
    sel.innerHTML = '';

    const topOptions = [
      { label: 'ã™ã¹ã¦', value: '__ALL__' },
      { label: 'è²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆBSï¼‰ã®ã¿', value: '__BS__' },
      { label: 'æç›Šè¨ˆç®—æ›¸ï¼ˆPLï¼‰ã®ã¿', value: '__PL__' },
      { label: 'ãã®ä»–ã®ã¿', value: '__OTHER__' },
    ];
    for (const o of topOptions) {
      const opt = document.createElement('option');
      opt.textContent = o.label;
      opt.value = o.value;
      sel.appendChild(opt);
    }

    const sep = document.createElement('option');
    sep.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€';
    sep.disabled = true;
    sel.appendChild(sep);

    for (const t of typeList) {
      const opt = document.createElement('option');
      opt.textContent = t;
      opt.value = t;
      sel.appendChild(opt);
    }
    sel.value = '__ALL__';
    
    sel.onchange = () => applyFiltersAndReady();
    document.getElementById('toggleOther').onchange = () => applyFiltersAndReady();
  }

  function allowByFilter(xType, filterType){
    if (filterType === '__ALL__') return true;
    if (filterType === '__BS__') return BS_TYPES.has(xType);
    if (filterType === '__PL__') return PL_TYPES.has(xType);
    if (filterType === '__OTHER__') return xType === 'ãã®ä»–';
    return xType === filterType;
  }

  function applyFiltersAndReady(){
    showQuizUI();
    const includeOther = document.getElementById('toggleOther').checked;
    const filterType = document.getElementById('typeFilter').value;

    let filtered = allItems.filter(x => {
      if (!includeOther && x.type === 'ãã®ä»–') return false;
      if (!allowByFilter(x.type, filterType)) return false;
      return true;
    });

    if (!filtered.length){
      document.getElementById('account').textContent = 'è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—';
      document.getElementById('buttons').innerHTML = '';
      return;
    }

    if (filtered.length > MAX_QUESTIONS) {
      shuffle(filtered);
      items = filtered.slice(0, MAX_QUESTIONS);
    } else {
      items = filtered;
    }

    lap = 0; 
    document.getElementById('lap').textContent = "0";
    prepareDeck();
    next();
  }

  // æ–‡å­—åˆ—ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆfetchä¸è¦ï¼‰
  function loadDataFromString() {
    try {
      const lines = RAW_CSV_DATA.split(/\r?\n/).filter(l => l.trim().length > 0);
      const header = lines.shift().split(',').map(s => s.trim());
      const idxAccount = header.indexOf('account');
      const idxType = header.indexOf('type');

      const parsed = [];
      for (const line of lines) {
        const cols = line.split(',').map(s => s.trim());
        const name = cols[idxAccount];
        const rawType = cols[idxType];
        if (name && rawType) {
          parsed.push({ name, type: normalizeType(rawType) });
        }
      }
      allItems = parsed;
      const set = new Set(parsed.map(x => x.type));
      types = sortTypesWithOrder(Array.from(set));

      buildTypeFilter(types);
      buildButtons(types);
      applyFiltersAndReady();
    } catch(e) {
      alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e);
    }
  }

  // â˜… ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ (Enter/Space)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ç”»é¢ãªã‚‰ã€Œæ¬¡ã¸ã€
      if (document.getElementById('stageClear').style.display === 'block') {
        startNextLap();
        e.preventDefault();
        return;
      }
      // é€šå¸¸æ™‚ã‚‚ã‚¹ã‚­ãƒƒãƒ—/æ¬¡ã¸
      next();
      e.preventDefault();
    }
  });

  (function init(){
    loadProgress();      // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    updateCharacterUI(); // ã‚­ãƒ£ãƒ©è¡¨ç¤º
    loadDataFromString();// å•é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  })();
</script>
</body>
</html>

